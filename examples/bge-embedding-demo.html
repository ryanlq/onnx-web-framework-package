<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BGE æ–‡æœ¬åµŒå…¥æ¨¡å‹æ¼”ç¤º - ONNX Web Framework</title>

  <!-- é‡è¦ï¼šå¿…é¡»åœ¨ä»»ä½•ä½¿ç”¨ ort çš„ä»£ç ä¹‹å‰åŠ è½½ -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    .content {
      padding: 30px;
    }
    .status-bar {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    .status-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .status-item:last-child {
      margin-bottom: 0;
    }
    .status-icon {
      margin-right: 10px;
      font-size: 16px;
    }
    .status-icon.pending { color: #6c757d; }
    .status-icon.loading { color: #007bff; }
    .status-icon.success { color: #28a745; }
    .status-icon.error { color: #dc3545; }
    .input-section {
      margin-bottom: 25px;
    }
    .input-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
      font-size: 16px;
    }
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      transition: border-color 0.3s;
    }
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .output-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .output-section h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
    }
    .output-content {
      background: white;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .comparison-section {
      margin-top: 20px;
    }
    .comparison-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }
    .comparison-text {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    .similarity-score {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– BGE æ–‡æœ¬åµŒå…¥æ¨¡å‹æ¼”ç¤º</h1>
      <p>åŸºäº ONNX Web Framework çš„ä¸­æ–‡æ–‡æœ¬å‘é‡åŒ– | BGE-small-zh-v1.5-INT8</p>
    </div>

    <div class="content">
      <!-- çŠ¶æ€æ  -->
      <div class="status-bar">
        <div class="status-item">
          <span class="status-icon pending" id="status-framework">âšª</span>
          <span>æ¡†æ¶åˆå§‹åŒ–</span>
        </div>
        <div class="status-item">
          <span class="status-icon pending" id="status-tokenizer">âšª</span>
          <span>Tokenizer åŠ è½½</span>
        </div>
        <div class="status-item">
          <span class="status-icon pending" id="status-model">âšª</span>
          <span>æ¨¡å‹åŠ è½½</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <!-- å•æ–‡æœ¬è¾“å…¥ -->
      <div class="input-section">
        <label>ğŸ“ è¾“å…¥æ–‡æœ¬</label>
        <textarea id="inputText" placeholder="è¯·è¾“å…¥è¦å‘é‡åŒ–çš„æ–‡æœ¬...">äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨æ”¹å˜ä¸–ç•Œ</textarea>
        <div class="button-group">
          <button id="embedBtn" class="btn-primary" onclick="embedText()" disabled>
            ç”ŸæˆåµŒå…¥å‘é‡
          </button>
          <button class="btn-secondary" onclick="loadExample()">
            åŠ è½½ç¤ºä¾‹
          </button>
        </div>
      </div>

      <!-- è¾“å‡ºåŒºåŸŸ -->
      <div class="output-section" id="outputSection" style="display:none;">
        <h3>ğŸ“Š åµŒå…¥å‘é‡ç»“æœ</h3>
        <div class="output-content" id="output"></div>
      </div>

      <!-- ç›¸ä¼¼åº¦æ¯”è¾ƒ -->
      <div class="input-section" style="margin-top: 25px;">
        <label>ğŸ” æ–‡æœ¬ç›¸ä¼¼åº¦æ¯”è¾ƒ</label>
        <textarea id="compareText1" placeholder="æ–‡æœ¬ 1..." style="margin-bottom: 10px;">äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨æ”¹å˜ä¸–ç•Œ</textarea>
        <textarea id="compareText2" placeholder="æ–‡æœ¬ 2...">æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯</textarea>
        <div class="button-group">
          <button id="compareBtn" class="btn-primary" onclick="compareTexts()" disabled>
            è®¡ç®—ç›¸ä¼¼åº¦
          </button>
        </div>
      </div>

      <div id="comparisonResult"></div>
    </div>
  </div>

  <script type="module">
    import ONNXWebFramework, { loadTokenizer } from '../dist/index.js';

    let framework = null;
    let tokenizer = null;
    let isReady = false;

    // æ›´æ–°çŠ¶æ€å›¾æ ‡
    function updateStatus(id, status) {
      const el = document.getElementById(id);
      el.className = 'status-icon ' + status;
      switch(status) {
        case 'loading':
          el.innerHTML = 'â³';
          break;
        case 'success':
          el.innerHTML = 'âœ…';
          break;
        case 'error':
          el.innerHTML = 'âŒ';
          break;
        default:
          el.innerHTML = 'âšª';
      }
    }

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(percent) {
      document.getElementById('progress-fill').style.width = percent + '%';
    }

    // åˆå§‹åŒ–
    async function init() {
      try {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–...');

        // 1. åˆå§‹åŒ–æ¡†æ¶
        updateStatus('status-framework', 'loading');
        framework = new ONNXWebFramework({
          executionProviders: ['wasm'],
          enableCache: true,
          debug: true
        });

        await framework.initialize();
        updateStatus('status-framework', 'success');
        updateProgress(33);
        console.log('âœ… æ¡†æ¶åˆå§‹åŒ–æˆåŠŸ');

        // 2. åŠ è½½ tokenizer
        updateStatus('status-tokenizer', 'loading');
        console.log('ğŸ“¥ åŠ è½½ tokenizer...');

        const tokenizerUrl = 'https://www.modelscope.cn/models/duchao/bge-small-zh-v1.5/resolve/master/tokenizer.json';
        tokenizer = await loadTokenizer(tokenizerUrl, { useCache: true });

        console.log('âœ… Tokenizer åŠ è½½æˆåŠŸ');
        console.log('è¯æ±‡è¡¨å¤§å°:', tokenizer.vocabSize);
        updateStatus('status-tokenizer', 'success');
        updateProgress(66);

        // 3. æ³¨å†Œé¢„å¤„ç†å™¨
        framework.registerPreprocessor('bge-model', async (text, options) => {
          console.log('âš™ï¸ é¢„å¤„ç†æ–‡æœ¬:', text);

          // ä½¿ç”¨ tokenizer åˆ†è¯
          const tokens = tokenizer.encode(text);
          console.log('Tokens:', tokens.ids.slice(0, 20), '...(å‰20ä¸ª)');

          // BGE æ¨¡å‹éœ€è¦çš„è¾“å…¥æ ¼å¼
          const { ort } = globalThis;
          const maxLength = 512;

          // æˆªæ–­æˆ–å¡«å……
          let inputIds = tokens.ids;
          let attentionMask = tokens.attentionMask;

          if (inputIds.length > maxLength) {
            inputIds = inputIds.slice(0, maxLength);
            attentionMask = attentionMask.slice(0, maxLength);
          }

          // è½¬æ¢ä¸º Tensorï¼ˆint64ï¼‰
          const feeds = {
            input_ids: new ort.Tensor(
              'int64',
              BigInt64Array.from(inputIds.map(BigInt)),
              [1, inputIds.length]
            ),
            attention_mask: new ort.Tensor(
              'int64',
              BigInt64Array.from(attentionMask.map(BigInt)),
              [1, attentionMask.length]
            ),
            token_type_ids: new ort.Tensor(
              'int64',
              BigInt64Array.from(tokens.typeIds.slice(0, inputIds.length).map(BigInt)),
              [1, inputIds.length]
            )
          };

          console.log('âœ… é¢„å¤„ç†å®Œæˆï¼Œåºåˆ—é•¿åº¦:', inputIds.length);
          return feeds;
        });

        // æ³¨å†Œåå¤„ç†å™¨
        framework.registerPostprocessor('bge-model', async (output, options) => {
          console.log('âš™ï¸ åå¤„ç†è¾“å‡º...');

          // è·å–åµŒå…¥å‘é‡
          const embeddingTensor = Object.values(output)[0];
          const embedding = Array.from(embeddingTensor.data);

          console.log('âœ… åå¤„ç†å®Œæˆï¼Œå‘é‡ç»´åº¦:', embedding.length);

          // å½’ä¸€åŒ–ï¼ˆL2 normalizationï¼‰
          const norm = Math.sqrt(embedding.reduce((sum, val) => sum + val * val, 0));
          const normalized = embedding.map(val => val / norm);

          return {
            dimension: normalized.length,
            embedding: normalized.slice(0, 10), // åªè¿”å›å‰10ä¸ªå€¼ç”¨äºæ˜¾ç¤º
            full_embedding: normalized // å®Œæ•´å‘é‡
          };
        });

        // 4. åŠ è½½æ¨¡å‹
        updateStatus('status-model', 'loading');
        console.log('ğŸ“¥ åŠ è½½ BGE æ¨¡å‹...');

        const modelUrl = 'https://www.modelscope.cn/models/duchao/bge-small-zh-v1.5/resolve/master/onnx/model_int8.ort';
        await framework.loadModel('bge-model', modelUrl);

        console.log('âœ… æ¨¡å‹åŠ è½½æˆåŠŸ');
        updateStatus('status-model', 'success');
        updateProgress(100);

        // å¯ç”¨æŒ‰é’®
        document.getElementById('embedBtn').disabled = false;
        document.getElementById('compareBtn').disabled = false;
        isReady = true;

        console.log('ğŸ‰ æ‰€æœ‰ç»„ä»¶å‡†å¤‡å®Œæ¯•ï¼');

      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        updateStatus('status-framework', 'error');
        updateStatus('status-tokenizer', 'error');
        updateStatus('status-model', 'error');

        showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    }

    // ç”ŸæˆåµŒå…¥å‘é‡
    async function embedText() {
      if (!isReady) {
        showError('æ¡†æ¶å°šæœªåˆå§‹åŒ–å®Œæˆ');
        return;
      }

      const text = document.getElementById('inputText').value.trim();
      if (!text) {
        showError('è¯·è¾“å…¥æ–‡æœ¬');
        return;
      }

      try {
        const btn = document.getElementById('embedBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>å¤„ç†ä¸­...';

        console.log('ğŸ”® å¼€å§‹æ¨ç†...');
        const result = await framework.predict('bge-model', text);
        console.log('âœ… æ¨ç†å®Œæˆ');

        // æ˜¾ç¤ºç»“æœ
        const outputSection = document.getElementById('outputSection');
        const output = document.getElementById('output');

        outputSection.style.display = 'block';
        output.innerHTML = `
å‘é‡ç»´åº¦: ${result.dimension}

å‰10ä¸ªå€¼:
${result.embedding.map((v, i) => `  [${i}]: ${v.toFixed(6)}`).join('\n')}

...
ï¼ˆå®Œæ•´å‘é‡å…± ${result.dimension} ç»´ï¼Œå·²å½’ä¸€åŒ–ï¼‰

æç¤ºï¼šè¿™æ˜¯æ–‡æœ¬çš„è¯­ä¹‰åµŒå…¥å‘é‡ï¼Œå¯ç”¨äºï¼š
  â€¢ æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—
  â€¢ è¯­ä¹‰æœç´¢
  â€¢ æ–‡æœ¬èšç±»
  â€¢ æ¨èç³»ç»Ÿ
        `;

        btn.disabled = false;
        btn.innerHTML = 'ç”ŸæˆåµŒå…¥å‘é‡';

      } catch (error) {
        console.error('âŒ æ¨ç†å¤±è´¥:', error);
        showError('æ¨ç†å¤±è´¥: ' + error.message);
        document.getElementById('embedBtn').disabled = false;
        document.getElementById('embedBtn').innerHTML = 'ç”ŸæˆåµŒå…¥å‘é‡';
      }
    }

    // æ¯”è¾ƒæ–‡æœ¬ç›¸ä¼¼åº¦
    async function compareTexts() {
      if (!isReady) {
        showError('æ¡†æ¶å°šæœªåˆå§‹åŒ–å®Œæˆ');
        return;
      }

      const text1 = document.getElementById('compareText1').value.trim();
      const text2 = document.getElementById('compareText2').value.trim();

      if (!text1 || !text2) {
        showError('è¯·è¾“å…¥ä¸¤ä¸ªæ–‡æœ¬');
        return;
      }

      try {
        const btn = document.getElementById('compareBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>è®¡ç®—ä¸­...';

        console.log('ğŸ” è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦...');

        // è·å–ä¸¤ä¸ªæ–‡æœ¬çš„åµŒå…¥
        const result1 = await framework.predict('bge-model', text1);
        const result2 = await framework.predict('bge-model', text2);

        // è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
        const similarity = cosineSimilarity(result1.full_embedding, result2.full_embedding);

        console.log('âœ… ç›¸ä¼¼åº¦è®¡ç®—å®Œæˆ:', similarity);

        // æ˜¾ç¤ºç»“æœ
        const resultDiv = document.getElementById('comparisonResult');
        const similarityPercent = (similarity * 100).toFixed(2);

        let similarityLevel = '';
        if (similarity > 0.8) {
          similarityLevel = 'ğŸŸ¢ éå¸¸ç›¸ä¼¼';
        } else if (similarity > 0.6) {
          similarityLevel = 'ğŸŸ¡ ç›¸ä¼¼';
        } else if (similarity > 0.4) {
          similarityLevel = 'ğŸŸ  éƒ¨åˆ†ç›¸ä¼¼';
        } else {
          similarityLevel = 'ğŸ”´ ä¸å¤ªç›¸ä¼¼';
        }

        resultDiv.innerHTML = `
          <div class="comparison-section">
            <div class="comparison-item">
              <div class="comparison-text">æ–‡æœ¬ 1: ${text1}</div>
              <div class="comparison-text">æ–‡æœ¬ 2: ${text2}</div>
              <div style="margin-top: 15px;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ä½™å¼¦ç›¸ä¼¼åº¦</div>
                <div class="similarity-score">${similarityPercent}%</div>
                <div style="font-size: 16px; margin-top: 5px;">${similarityLevel}</div>
              </div>
            </div>
          </div>
        `;

        btn.disabled = false;
        btn.innerHTML = 'è®¡ç®—ç›¸ä¼¼åº¦';

      } catch (error) {
        console.error('âŒ ç›¸ä¼¼åº¦è®¡ç®—å¤±è´¥:', error);
        showError('è®¡ç®—å¤±è´¥: ' + error.message);
        document.getElementById('compareBtn').disabled = false;
        document.getElementById('compareBtn').innerHTML = 'è®¡ç®—ç›¸ä¼¼åº¦';
      }
    }

    // ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
    function cosineSimilarity(vec1, vec2) {
      let dotProduct = 0;
      let norm1 = 0;
      let norm2 = 0;

      for (let i = 0; i < vec1.length; i++) {
        dotProduct += vec1[i] * vec2[i];
        norm1 += vec1[i] * vec1[i];
        norm2 += vec2[i] * vec2[i];
      }

      return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
    }

    // åŠ è½½ç¤ºä¾‹
    function loadExample() {
      document.getElementById('inputText').value = 'äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨æ”¹å˜ä¸–ç•Œ';
      document.getElementById('compareText1').value = 'äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨æ”¹å˜ä¸–ç•Œ';
      document.getElementById('compareText2').value = 'æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯';
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      const outputSection = document.getElementById('outputSection');
      const output = document.getElementById('output');

      outputSection.style.display = 'block';
      output.innerHTML = `<span style="color: #dc3545;">âŒ ${message}</span>`;
    }

    // å¯¼å‡ºåˆ°å…¨å±€
    window.embedText = embedText;
    window.compareTexts = compareTexts;
    window.loadExample = loadExample;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
