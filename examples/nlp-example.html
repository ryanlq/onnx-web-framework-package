<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NLP æ¨¡å‹ç¤ºä¾‹ - ONNX Web Framework</title>

  <!-- åŠ è½½ onnxruntime-web (UMD ç‰ˆæœ¬) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.18.0/dist/ort.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: monospace;
      resize: vertical;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .output {
      background: white;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
    .loading {
      color: #666;
    }
    .error {
      color: #dc3545;
    }
    .success {
      color: #28a745;
    }
  </style>
</head>
<body>
  <h1>ğŸ¤– NLP æ¨¡å‹æ¨ç†ç¤ºä¾‹</h1>
  <p>æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ ONNX Web Framework å’Œ Tokenizer è¿›è¡Œæ–‡æœ¬åˆ†ç±»ä»»åŠ¡</p>

  <div class="container">
    <h2>è¾“å…¥æ–‡æœ¬</h2>
    <textarea id="inputText" placeholder="è¯·è¾“å…¥è¦åˆ†ç±»çš„æ–‡æœ¬...">
è¿™éƒ¨ç”µå½±çœŸçš„å¾ˆå¥½çœ‹ï¼Œå‰§æƒ…ç´§å‡‘ï¼Œæ¼”å‘˜æ¼”æŠ€å‡ºè‰²ï¼Œå¼ºçƒˆæ¨èï¼
    </textarea>
    <button id="runBtn" onclick="runInference()">è¿è¡Œæ¨ç†</button>
  </div>

  <div class="container">
    <h2>è¾“å‡ºç»“æœ</h2>
    <div id="output" class="output">ç­‰å¾…è¿è¡Œ...</div>
  </div>

  <script type="module">
    import ONNXWebFramework, { loadTokenizer } from './dist/onnx-web-framework.es.js';

    let framework = null;
    let tokenizer = null;

    // åˆå§‹åŒ–
    async function init() {
      try {
        output('ğŸš€ åˆå§‹åŒ–æ¡†æ¶...', 'loading');

        // åˆ›å»ºæ¡†æ¶å®ä¾‹
        framework = new ONNXWebFramework({
          executionProviders: ['wasm'],
          enableCache: true
        });

        await framework.initialize();
        output('âœ… æ¡†æ¶åˆå§‹åŒ–æˆåŠŸ', 'success');

        // åŠ è½½ tokenizerï¼ˆç¤ºä¾‹ URLï¼Œå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºçœŸå®çš„ tokenizer.jsonï¼‰
        // tokenizer = await loadTokenizer('https://example.com/tokenizer.json');

        output('ğŸ“ å‡†å¤‡åŠ è½½æ¨¡å‹...', 'loading');

        // åŠ è½½æ¨¡å‹ï¼ˆç¤ºä¾‹ URLï¼Œå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºçœŸå®çš„æ¨¡å‹ï¼‰
        // await framework.loadModel('text-classifier', 'models/text-classifier.onnx');

        output('âœ… å‡†å¤‡å·¥ä½œå®Œæˆï¼\n\næ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦ï¼š\n1. æ›¿æ¢ä¸ºçœŸå®çš„ tokenizer.json URL\n2. æ›¿æ¢ä¸ºçœŸå®çš„æ¨¡å‹æ–‡ä»¶ URL\n3. æ ¹æ®æ¨¡å‹è¾“å…¥è¾“å‡ºæ ¼å¼è°ƒæ•´é¢„å¤„ç†å™¨', 'success');

      } catch (error) {
        output(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // æ³¨å†Œé¢„å¤„ç†å™¨
    function registerPreprocessors() {
      // æ–‡æœ¬åˆ†ç±»é¢„å¤„ç†å™¨
      framework.registerPreprocessor('text-classifier', async (text, options) => {
        output('âš™ï¸  é¢„å¤„ç†æ–‡æœ¬...', 'loading');

        // 1. ä½¿ç”¨ tokenizer åˆ†è¯
        const tokens = tokenizer.encode(text);

        // 2. è½¬æ¢ä¸º ONNX Runtime Tensor
        const { ort } = globalThis;
        const feeds = {
          input_ids: new ort.Tensor('int64', BigInt64Array.from(tokens.ids.map(BigInt)), [1, tokens.ids.length]),
          attention_mask: new ort.Tensor('int64', BigInt64Array.from(tokens.attentionMask.map(BigInt)), [1, tokens.attentionMask.length])
        };

        output(`âœ… é¢„å¤„ç†å®Œæˆï¼Œtokens: ${tokens.ids.length}`, 'success');
        return feeds;
      });

      // æ–‡æœ¬åˆ†ç±»åå¤„ç†å™¨
      framework.registerPostprocessor('text-classifier', async (output, options) => {
        output('âš™ï¸  åå¤„ç†è¾“å‡º...', 'loading');

        // å‡è®¾æ¨¡å‹è¾“å‡ºæ˜¯ logitsï¼Œè½¬æ¢ä¸ºæ¦‚ç‡
        const logits = Object.values(output)[0]; // è·å–ç¬¬ä¸€ä¸ªè¾“å‡º
        const probs = softmax(Array.from(logits.data));

        // è·å–é¢„æµ‹ç»“æœ
        const predictedClass = probs.indexOf(Math.max(...probs));
        const confidence = probs[predictedClass];

        const result = {
          class: predictedClass,
          confidence: confidence,
          probabilities: probs
        };

        output(`âœ… é¢„æµ‹å®Œæˆ: ç±»åˆ« ${result.class}, ç½®ä¿¡åº¦ ${(result.confidence * 100).toFixed(2)}%`, 'success');
        return result;
      });
    }

    // Softmax å‡½æ•°
    function softmax(arr) {
      const max = Math.max(...arr);
      const exps = arr.map(x => Math.exp(x - max));
      const sum = exps.reduce((a, b) => a + b);
      return exps.map(x => x / sum);
    }

    // è¿è¡Œæ¨ç†
    async function runInference() {
      if (!framework) {
        output('âŒ æ¡†æ¶æœªåˆå§‹åŒ–', 'error');
        return;
      }

      const inputText = document.getElementById('inputText').value;

      try {
        // ä½¿ç”¨ predict() APIï¼Œä¼šè‡ªåŠ¨è°ƒç”¨é¢„å¤„ç†å™¨å’Œåå¤„ç†å™¨
        const result = await framework.predict('text-classifier', inputText);

        // æ˜¾ç¤ºç»“æœ
        output(`ğŸ¯ é¢„æµ‹ç»“æœï¼š\n${JSON.stringify(result, null, 2)}`, 'success');

      } catch (error) {
        output(`âŒ æ¨ç†å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // è¾“å‡ºè¾…åŠ©å‡½æ•°
    function output(message, type = '') {
      const outputEl = document.getElementById('output');
      outputEl.textContent = message;
      outputEl.className = 'output ' + type;
    }

    // å¯¼å‡ºåˆ°å…¨å±€
    window.runInference = runInference;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    init().then(() => {
      registerPreprocessors();
    });
  </script>
</body>
</html>
